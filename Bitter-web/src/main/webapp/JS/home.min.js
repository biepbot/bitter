var default_user="biepbot";var data={};data.user={};data.user.name=default_user;data.register=[];data.barktemplate='<div class="bark flash">            <div class="bark-image">                <img src="$avatar" class="user-image"/>            </div>            <div class="bark-user">                @$name            </div>            <div class="bark-content">                $content            </div>            <div class="bark-interact">                <li>                    <ul class="ul-bite"><span class="fa fa-bolt"></span>bite</ul>                    <ul class="ul-bark"><span class="fa fa-share-alt"></span>bark</ul>                    <ul><span class="fa fa-reply"></span>reply</ul>                </li>            </div>        </div>';var tl=new Timeline();var testbark=$("test-bark");testbark=tl.getPreviewBark(testbark);var barkEle=$("bark");barkEle.addEventListener("keyup",function(event){event.preventDefault();if(testbark.parseContent(this.value)===testbark.content){return}if(!tt){tt=true;setTimeout(afterType,delay)}typing=true});var d=$("darkener");saveElement(d);var delay=500;var tt=false;var typing=false;function afterType(){if(!typing){testbark.setContent(barkEle.value);tt=false}else{typing=false;setTimeout(afterType,delay)}}function bark(){if(barkEle.value){tl.bark(barkEle.value);testbark.clear()}}function loadUser(who,type){if(who==null){who=data.user.name}if(type==null){type=""}apicall("GET","api/users/"+who,function(e){for(var i=0;i<data.register.length;i++){var r=data.register[i];var ele=$(type+r.element);var val=e[r.value];data[r.value]=val;if(val!==""){if(ele){ele.innerHTML=val}}else{hide(ele)}}var color=e.color||"#ffec58";var header=$(type+"header");if(header){header.style.background=color}var a=e.avatar||"";var avatar=$(type+"avatar");if(avatar){avatar.src=a}data.user.avatar=a})}function hideIfDarkener(e){if(e.target.id==="darkener"){hide(e.target);removeClass(document.body,"no-overflow");var parent=$("modal-bark-replies");parent.innerHTML='<div id="modal-replies"></div>'}}function registerElement(element,property){var d={};d.element=element;d.value=property;data.register.push(d)}registerElement("username","name");registerElement("at_username","name");registerElement("barks_count","bark_count");registerElement("follower_count","follower_count");registerElement("following_count","following_count");loadUser();loadUser(null,"test-");function Timeline(){this.barks=[];Timeline.prototype.load=function(){var me=this;apicall("GET","api/users/"+data.user.name+"/timeline",function(e){for(var i=0;i<e.length;i++){var ei=e[i];var bark=new Bark(ei);me.addBark(bark)}})};Timeline.prototype.bark=function(msg){var d="bark="+msg;var me=this;call("POST","api/users/"+data.user.name+"/bark",d,function(e,success){if(success){var bark=new Bark(JSON.parse(e));me.addBark(bark);var b=$("barks_count");var amount=b.innerHTML;amount++;b.innerHTML=amount;flash(b);bark.flash()}else{console.log(e)}},1);var b2=$("bark");b2.value=""};Timeline.prototype.addBark=function(bark){this.barks.push(bark);bark.render()};Timeline.prototype.getPreviewBark=function(element){var details={id:-1};var b=new Bark(details);b.registerElement(element);return b};this.load();function Bark(details){this.id=details.id;this.details=details;this.element=null;this.replies=[];this.isLoadingPreview=false;Bark.prototype.follow=function(un){var followbtn=$("follow_btn");followbtn.onclick=function(){};followbtn.innerHTML=un===""?"Following...":"Unfollowing...";var me=this;call("POST","api/users/"+data.user.name+"/"+un+"follow/"+this.details.poster.name,null,function(e,success){if(success){me.loadOwner();if(e==1){followbtn.innerHTML="Unfollow";followbtn.onclick=function(){follow("un")}}else{followbtn.innerHTML="Follow";followbtn.onclick=function(){follow("")}}flash($("modal-ownerfollower_count"))}else{}})};Bark.prototype.clear=function(){this.setContent("")};Bark.prototype.setContent=function(content){this.content=this.parseContent(content);var c=this.element.getElementsByClassName("bark-content")[0];content=this.nicifyContent(content);c.innerHTML=content};Bark.prototype.parseContent=function(content){while(content.indexOf("\n\n\n")>-1){content=content.replace(/\n\n\n/g,"\n\n")}return content};Bark.prototype.nicifyContent=function(content){content=urlify(escapeHtml(content));content=content.replace(/\n/g,"<br />");if(!this.isLoadingPreview){this.isLoadingPreview=true;var urls=getUrls(content);if(urls.length){var who=this;for(var i=0;i<urls.length;i++){var u=urls[i];getPreview(u,function(e,succ){if(succ){who.loadPreviewFromJSON(e,u)}who.isLoadingPreview=false})}}else{this.isLoadingPreview=false}}var usernames=/@[a-zA-Z0-9]{0,}/g;content=content.replace(usernames,function(user){user=user.replace("@","");return'<a href="users/'+user+'.jsp">@'+user+"</a>"});return content};Bark.prototype.registerElement=function(element){this.element=element};Bark.prototype.updateStatus=function(){var id=this.id;var ele=this.element;apicall("GET","api/barks/"+id+"/likes/"+data.user.name,function(e){removeClass(ele,"$bitten");if(e==1){addClass(ele,"bitten")}else{removeClass(ele,"bitten")}});apicall("GET","api/barks/"+id+"/rebarks/"+data.user.name,function(e){removeClass(ele,"$barked");if(e==1){addClass(ele,"barked")}else{removeClass(ele,"barked")}})};Bark.prototype.loadOwner=function(){var n=this.details.poster.name;var you=n===data.user.name;loadUser(n,"modal-owner");var profile=$("visit_user");var followbtn=$("follow_btn");profile.href="users/"+n+".jsp";if(you){hide(followbtn);profile.innerHTML="Visit your profile"}else{show(followbtn);profile.innerHTML="Visit "+n+"'s profile";var me=this;apicall("GET","api/users/"+data.user.name+"/following",function(e){var follows=false;for(var i=0;i<e.length;i++){var u=e[i];if(u.name===n){follows=true;break}}if(follows){followbtn.innerHTML="Unfollow";followbtn.onclick=function(){me.follow("un")}}else{followbtn.innerHTML="Follow";followbtn.onclick=function(){me.follow("")}}})}};Bark.prototype.loadBark=function(){var img=$("modal-avatar");img.src=this.details.poster.avatar;var cnt=$("modal-bark-content");cnt.innerHTML=this.content;var use=$("modal-bark-username");use.innerHTML=this.details.poster.name;var rep=$("modal-reply-button");var who=this;var id=this.id;rep.onclick=function(){var v=$("modal-reply").value;if(v!==""){var d="content="+v;call("POST","api/barks/"+id+"/replyAs/"+data.user.name,d,function(e,success){if(success){who.replies.push(JSON.parse(e));var bark=new Bark(JSON.parse(e));var b=$("barks_count");var amount=b.innerHTML;amount++;b.innerHTML=amount;flash(b);var where=$("modal-replies");bark.render(where);bark.flash()}else{console.log(e)}},1)}$("modal-reply").value=""};if(this.replies.length===0){var who=this;apicall("GET","api/barks/"+this.id+"/replies",function(e){who.replies=e;who.renderReplies()})}else{this.renderReplies()}};Bark.prototype.openOwner=function(){restoreElement($("darkener"));this.loadOwner();show($("darkener"));show($("modal-owner"));hide($("big-bark"))};Bark.prototype.openBark=function(){restoreElement($("darkener"));this.loadBark();show($("darkener"));hide($("modal-owner"));show($("big-bark"));addClass(document.body,"no-overflow")};Bark.prototype.isLiked=function(){return hasClass(this.element,"ul-bite")};Bark.prototype.isRebarked=function(){return hasClass(this.element,"ul-bark")};Bark.prototype.like=function(){var id=this.id;var element=this.element;apicall("POST","api/users/"+data.user.name+"/like/"+id,function(e){if(e===1){addClass(element,"bitten")}else{removeClass(element,"bitten")}})};Bark.prototype.rebark=function(){var id=this.id;var element=this.element;apicall("POST","api/users/"+data.user.name+"/rebark/"+id,function(e){if(e===1){addClass(element,"barked")}else{removeClass(element,"barked")}})};Bark.prototype.addPreview=function(original,title,desc,image,url){var c=this.element.getElementsByClassName("bark-content")[0];var original2=original.replace(/\/+$/,"");original='<a href="'+original+'">'+original+"</a>";original2='<a href="'+original2+'">'+original2+"</a>";c.innerHTML=c.innerHTML.replace(original,"");c.innerHTML=c.innerHTML.replace(original2,"");var div=document.createElement("a");div.href=url;addClass(div,"rich-preview");var t=document.createElement("p");t.innerHTML=title;div.appendChild(t);var d=document.createElement("p");d.innerHTML=desc;div.appendChild(d);var div2=document.createElement("div");var i=document.createElement("img");i.src=image;addClass(div2,"preview-image");div2.appendChild(i);div.appendChild(div2);c.insertAdjacentElement("beforeend",div)};Bark.prototype.loadPreviewFromJSON=function(json,url){json=JSON.parse(json);this.addPreview(url,json.title,json.description,json.image,json.url)};function getUrls(content){var d=document.createElement("div");d.innerHTML=content;var as=d.getElementsByTagName("A");var urls=[];for(var i=0;i<as.length;i++){if(as[i].children.length===0){urls.push(as[i].href)}}return urls}Bark.prototype.renderReplies=function(){var where=$("modal-replies");for(var i=0;i<this.replies.length;i++){var e=this.replies[i];var b=new Bark(e);b.render(where)}};Bark.prototype.render=function(where){if(where==null){where=$("new-bark")}var who=this;var t=data.barktemplate;t=replaceAll(t,"$avatar",details.poster.avatar);t=replaceAll(t,"$name",details.poster.name);var ele=elementFromString(t);ele.id=this.id;ele.onclick=function(e){if(hasClass(e.target,"ul-bite")){who.like()}else{if(hasClass(e.target,"ul-bark")){who.rebark()}else{if(hasClass(e.target,"user-image")){who.openOwner()}else{who.openBark()}}}};this.registerElement(ele);where.insertAdjacentElement("afterend",ele);this.updateStatus();this.setContent(details.content)};Bark.prototype.flash=function(){flash(this.element)}}};